name: Backend CI/CD

on:
  workflow_dispatch:
    inputs:
      run-type:
        description: "Run option"
        required: true
        default: "Deploy-to-Staging(testnet)"
        type: choice
        options:
          - Code-Quality
          - Deploy-to-Staging(testnet)
          - Deploy-to-Prod(mainnet)

jobs:
  set-outputs:
    name: Set outputs
    uses: ./.github/actions/backend/set-outputs.yaml
    with:
      run-type: ${{ inputs.run-type }}
    secrets:
      HEROKU_APP_NAME_STAGING_TESTNET: ${{ secrets.HEROKU_BACKEND_APP_NAME_STAGING_TESTNET }}
      HEROKU_APP_NAME_PROD_MAINNET: ${{ secrets.HEROKU_BACKEND_APP_NAME_PROD_MAINNET }}

  build:
    name: Build backend
    needs: [set-outputs]
    uses: ./.github/actions/backend/build.yaml

  code-quality:
    name: Code Quality
    needs: [build]
    uses: ./.github/actions/backend/code-quality.yaml

  deploy-staging-testnet:
    name: Deploy to Heroku (Staging Testnet)
    needs: [set-outputs, build, code-quality]
    if: needs.code-quality.result == 'success' && needs.build.result == 'success' && needs.set-outputs.result == 'success' && needs.set-outputs.outputs.environment != 'Disabled'
    uses: ./.github/actions/backend/deploy-heroku.yaml
    with:
      environment: ${{ needs.set-outputs.outputs.environment }}
      heroku_app_name: ${{ needs.set-outputs.outputs.resource_name }}
      version: ${{ needs.set-outputs.outputs.version_number }}
    secrets:
      HEROKU_API_KEY: ${{ secrets.HEROKU_API_KEY }}

  deploy-prod-mainnet:
    name: Deploy to Heroku (Production Mainnet)
    needs: [set-outputs, deploy-staging-testnet]
    if: needs.deploy-staging-testnet.result == 'success' && needs.set-outputs.result == 'success' && needs.set-outputs.outputs.environment != 'Disabled'
    uses: ./.github/actions/backend/deploy-heroku.yaml
    with:
      environment: ${{ needs.set-outputs.outputs.environment }}
      heroku_app_name: ${{ needs.set-outputs.outputs.resource_name }}
      version: ${{ needs.set-outputs.outputs.version_number }}
    secrets:
      HEROKU_API_KEY: ${{ secrets.HEROKU_API_KEY }}
